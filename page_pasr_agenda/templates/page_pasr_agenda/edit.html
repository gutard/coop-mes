{% load thumbnail crispy_forms_tags staticfiles %}

<div class="main-content">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 sidebar sidebar--left">
                {% include "forms-menu.html" %}
            </div>
            <div class="col-lg-9">
                <div class="content-box">
                    <div class="section-head">
                        <h1 class="title">PROPOSER UN EVENEMENT</h1>
                    </div>
                    {% if form.instance.status == 0 %}
                        Vous pouvez enregistrer l'événement pour le modifier plus tard. Lorsque vous êtes prêt à demander sa publication, cliquez sur le bouton « Proposer l'événement ».
                    {% elif form.instance.status == 2 %}
                        Votre événement est en attente de validation par les administrateurs du site.
                    {% endif %}
                    <form class="form form-horizontal" action="#" enctype="multipart/form-data" method="post">
                        <fieldset>
                            {% crispy form %}
                        </fieldset>
                        <fieldset>
                            {% crispy form3 %}
                        </fieldset>
                        {{ form2.management_form }}
                        {% for subform in form2.forms %}
                            {{ subform.id }}
                            {% crispy subform %}
                        {% endfor %}
                        <fieldset class="text-center">
                            <button class="add-link btn btn--form" data-model="occurrence">Ajouter une plage horaire</button>
                        </fieldset>
                        {{ form4.management_form }}
                        {% for subform in form4.forms %}
                            {{ subform.id }}
                            {% crispy subform %}
                        {% endfor %}
                        <fieldset class="text-center">
                            <button class="add-link btn btn--form" data-model="eventdocument">Ajouter un document</button>
                        </fieldset>
                        <fieldset class="text-center">
                            <button type="submit" class="btn btn-default">Enregistrer</button>
                            {% if form.instance.status == 'I' %}
                                <button type="submit" name='propose' class="btn btn--form">Proposer l'événement</button>
                            {% endif %}
                        </fieldset>
                        <p><b>*</b> champs obligatoires</p>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="{% static 'mce_filebrowser/js/filebrowser_init.js' %}"></script>

<script type="text/javascript">

jQuery(document).ready(function() {

    /* Tags autoselect */

    $('.as-selections').addClass('form-control');
    $('.as-input').removeClass('form-control');

    /* Date picker */

    $('.dateinput').not($('.occurrence-form:last .dateinput')).datepicker({'format': 'dd/mm/yyyy', 'weekStart': 1, 'language': 'fr', 'autoclose': true});

    /* Select2 */

    $('select').select2();

    /* Formset */
    $('.occurrence-form:last').hide();
    $('.eventdocument-form:last').hide();
    var hidden_id = new Array();
    hidden_id['occurrence'] = $('#id_occurrence_set-TOTAL_FORMS').val();
    hidden_id['eventdocument'] = $('#id_eventdocument_set-TOTAL_FORMS').val();

    $('.add-link').click(function() {
        var model = $(this).attr('data-model');
        var newElement = $('.' + model + '-form:last').clone(true);
        var total = $('#id_' + model + '_set-TOTAL_FORMS').val();
        newElement.find('[id^="id_"]:input').each(function() {
            var name = $(this).attr('name').replace('-' + (hidden_id[model]-1) + '-','-' + total + '-');
            var id = 'id_' + name;
            $(this).attr({'name': name, 'id': id});
        });
        newElement.find('label').each(function() {
            var newFor = $(this).attr('for').replace('-' + (hidden_id[model]-1) + '-','-' + total + '-');
            $(this).attr('for', newFor);
        });
        newElement.find('.dateinput').datepicker({'format': 'dd/mm/yyyy', 'weekStart': 1, 'language': 'fr', 'autoclose': true});
        total++;
        $('#id_' + model + '_set-TOTAL_FORMS').val(total);
        $('.' + model + '-form:last').before(newElement);
        newElement.show();
        return false;
    });

    $('.delete-link').click(function() {
        $(this).parent().find("input").prop('checked', true);
        $(this).parents("fieldset").addClass("hidden");
        return false;
    });

});

</script>
